{% extends "layout.html" %}

{% block title %}Checkout - AceCourt{% endblock %}

{% block styles %}
<style>
    .payment-method {
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .payment-method:hover {
        border-color: #0d6efd;
    }
    .payment-method.active {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    #paypal-button-container {
        max-width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Checkout</h1>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('booking.calendar') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Calendar
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Booking Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Court</h6>
                            <p class="mb-0"><strong>{{ booking.court.name }}</strong></p>
                            <p class="text-muted">{{ booking.court.court_type.title() }} Court {{ '(Indoor)' if booking.court.indoor else '(Outdoor)' }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Date & Time</h6>
                            <p class="mb-0"><strong>{{ booking.start_time.strftime('%A, %B %d, %Y') }}</strong></p>
                            <p class="text-muted">{{ booking.start_time.strftime('%I:%M %p') }} - {{ booking.end_time.strftime('%I:%M %p') }}</p>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Your booking will be confirmed once payment is complete.
                    </div>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Select Payment Method</h5>
                </div>
                <div class="card-body">
                    <div class="payment-method active" id="paypal-method">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <img src="https://www.paypalobjects.com/digitalassets/c/website/marketing/na/us/logo-center/Badge_3.svg" 
                                     alt="PayPal" height="30">
                            </div>
                            <div>
                                <strong>PayPal</strong>
                                <p class="mb-0 text-muted">Pay securely using PayPal</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paypal-button-container" class="mt-4"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Price Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Court Rate:</span>
                        <span>${{ booking.court.base_price_per_hour }} / hour</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Duration:</span>
                        <span>{{ (booking.end_time - booking.start_time).seconds // 3600 }} hour(s)</span>
                    </div>
                    
                    <!-- This section would be dynamic based on pricing rules in a real app -->
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span>${{ price|default(booking.court.base_price_per_hour) }}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong>${{ price|default(booking.court.base_price_per_hour) }}</strong>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Cancellation Policy</h5>
                </div>
                <div class="card-body">
                    <p><i class="fas fa-info-circle text-primary"></i> Free cancellation up to 24 hours before your booking.</p>
                    <p><i class="fas fa-info-circle text-primary"></i> Cancellations within 24 hours of the booking time are non-refundable.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id|default('sandbox_client_id') }}&currency=USD"></script>
<script>
    // This sets up the PayPal buttons
    paypal.Buttons({
        // Set up the transaction
        createOrder: function(data, actions) {
            return fetch('/payment/api/create-paypal-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    booking_id: '{{ booking.id }}'
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(data) {
                        throw new Error(data.error || 'Something went wrong');
                    });
                }
                return response.json();
            })
            .then(function(data) {
                return data.orderId;
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('There was a problem creating your order. ' + error.message);
            });
        },
        
        // Finalize the transaction
        onApprove: function(data, actions) {
            return fetch('/payment/api/capture-paypal-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    orderID: data.orderID,
                    bookingId: '{{ booking.id }}'
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(function(data) {
                        throw new Error(data.error || 'Something went wrong');
                    });
                }
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // Redirect to success page
                    window.location.href = data.redirectUrl;
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('There was a problem completing your payment. ' + error.message);
            });
        },
        
        onError: function(err) {
            console.error('PayPal Error:', err);
            alert('There was an error with PayPal. Please try again or contact support.');
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}
